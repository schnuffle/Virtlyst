#!/bin/sh
#
# Post-installation script for the Virtlyst package for Ubuntu  GNU/Linux
#
#

set -e

# We generate several files during the postinst, and we don't want
#       them to be readable only by root.
umask 022

# add the virtlyst group
if ! getent group virtlyst >/dev/null;
then
        addgroup --system virtlyst
fi
# add the virtlyst user
if ! getent passwd virtlyst >/dev/null; 
then
    adduser --disabled-password  --quiet --system \
        --home /usr/local/var/virtlyst --no-create-home\
        --gecos "Virtlyst" --group virtlyst
    adduser --quiet virtlyst libvirt
fi

# Create config
cat << EOF > /etc/virtlyst.conf
[wsgi]
master = true
threads = auto
http-socket = :3000
application = /usr/local/lib/libVirtlyst.so
chdir2 = /usr/local/var/virtlyst
static-map = /static=/usr/local/var/virtlyst/root/static

[Cutelyst]
production = true
DatabasePath = /usr/local/var/virtlyst/virtlyst.sqlite 
               /usr/local/var/virtlyst/virt.sqlite
TemplatePath = /usr/local/var/virtlyst/root/src

[Rules]
cutelyst.* = true
virtlyst.* = true
EOF

# Add the new lib paths to ld config
cat << EOF > /etc/ld.so.conf.d/virtlyst.conf
/usr/local/lib
/usr/local/lib/x86_64-linux-gnu
/usr/local/lib/cutelyst2-plugins
EOF

# Activate new lib paths
ldconfig

# create systemd unit file
cat << EOF > /etc/systemd/system/virtlyst.service
[Unit]
After=network.target libvirtd.service
Description=Web interface to manage virtual machines with libvirt

[Service]
Type=notify
NotifyAccess=all
#DynamicUser=yes
User=virtlyst
Restart=always
ExecStart=/usr/local/bin/cutelyst-wsgi2 --ini /etc/virtlyst.conf
StateDirectory=virtlyst

[Install]
WantedBy=multi-user.target
EOF

# Load unit file
systemctl daemon-reload

# Set correct owner
chown virtlyst:virtlyst -R /usr/local/var/virtlyst
chown virtlyst:virtlyst /etc/virtlyst.conf
chmod 770 /usr/local/var/virtlyst
>>>>>>> Added file to build debian package

